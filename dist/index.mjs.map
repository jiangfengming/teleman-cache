{"version":3,"file":"index.mjs","sources":["../src/index.mjs"],"sourcesContent":["export default ({\n  variable = '__SSR_CACHE__',\n  mode = window[variable] ? 'client' : 'server',\n  cacheKeyGenerator,\n  cacheValidator,\n  useCacheOnError,\n  onServerRendered,\n  onClientPreloaded\n} = {}) => {\n  let cache, script, serverIdleTimer, clientIdleTimer\n\n  if (mode === 'server') {\n    if (onClientPreloaded) {\n      onClientPreloaded()\n    }\n\n    cache = []\n    resetServerIdleTimer()\n  } else {\n    if (window[variable]) {\n      cache = window[variable] = JSON.parse(decodeURI(window[variable]))\n    }\n\n    if (onClientPreloaded) {\n      if (!cache || !cache.length) {\n        onClientPreloaded()\n        onClientPreloaded = null\n      } else {\n        resetClientIdleTimer()\n      }\n    }\n  }\n\n  function resetServerIdleTimer() {\n    clearTimeout(serverIdleTimer)\n\n    serverIdleTimer = setTimeout(() => {\n      if (!script) {\n        script = document.createElement('script')\n        document.body.insertBefore(script, document.body.getElementsByTagName('script')[0] || null)\n      }\n\n      script.text = `var ${variable} = \"${encodeURI(JSON.stringify(cache))}\"`\n\n      if (onServerRendered) {\n        onServerRendered()\n        onServerRendered = null\n      }\n    }, 400)\n  }\n\n  function resetClientIdleTimer() {\n    clearTimeout(clientIdleTimer)\n\n    if (onClientPreloaded) {\n      clientIdleTimer = setTimeout(() => {\n        if (onClientPreloaded) {\n          onClientPreloaded()\n          onClientPreloaded = null\n        }\n      }, 400)\n    }\n  }\n\n  return (ctx, next) => {\n    if (!cache || ctx.options.method && ctx.options.method.toUpperCase() !== 'GET') {\n      return next()\n    }\n\n    const key = cacheKeyGenerator ? cacheKeyGenerator(ctx) : ctx.url\n    const hit = cache.find(item => item.key === key)\n\n    if (mode === 'server') {\n      if (hit) {\n        return hit.body\n      }\n\n      clearTimeout(serverIdleTimer)\n\n      return next().then(body => {\n        cache.push({\n          key,\n          body: JSON.parse(JSON.stringify(body)) // unreference\n        })\n        return body\n      }).finally(() => {\n        resetServerIdleTimer()\n      })\n    } else {\n      resetClientIdleTimer()\n\n      if (!hit) {\n        return next().finally(() => resetClientIdleTimer())\n      }\n\n      if (cacheValidator ? cacheValidator(ctx) : true) {\n        cleanCache()\n        return hit.body\n      } else {\n        let promise = next()\n\n        if (useCacheOnError) {\n          promise = promise.catch(e => {\n            if (useCacheOnError === true ||\n              useCacheOnError && useCacheOnError.constructor === Function && useCacheOnError(e, hit.body, ctx)) {\n              return hit.body\n            } else {\n              throw e\n            }\n          })\n        }\n\n        return promise.finally(() => {\n          cleanCache()\n          resetClientIdleTimer()\n        })\n      }\n    }\n\n    function cleanCache() {\n      if (!cache) {\n        return\n      }\n\n      const i = cache.indexOf(hit)\n\n      if (i === -1) {\n        return\n      }\n\n      cache.splice(i, 1)\n\n      if (!cache.length) {\n        cache = null\n\n        if (onClientPreloaded) {\n          clearTimeout(clientIdleTimer)\n          onClientPreloaded()\n          onClientPreloaded = null\n        }\n      }\n    }\n  }\n}\n"],"names":["variable","mode","window","cacheKeyGenerator","cacheValidator","useCacheOnError","onServerRendered","onClientPreloaded","cache","script","serverIdleTimer","clientIdleTimer","resetServerIdleTimer","JSON","parse","decodeURI","length","resetClientIdleTimer","clearTimeout","setTimeout","document","createElement","body","insertBefore","getElementsByTagName","text","encodeURI","stringify","ctx","next","options","method","toUpperCase","key","url","hit","find","item","then","push","cleanCache","promise","e","constructor","Function","i","indexOf","splice"],"mappings":"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"}