{"version":3,"file":"telemanCache.mjs","sources":["../src/index.mjs"],"sourcesContent":["export default ({ mode, variable, cacheKeyGenerator, tagGenerator, onServerCached, onClientConsumed } = {}) => {\n  let cache, script, serverIdleTimer, clientIdleTimer\n\n  if (mode === 'server') {\n    if (onClientConsumed) onClientConsumed()\n    cache = []\n    script = document.createElement('script')\n    document.body.insertBefore(script, document.body.getElementsByTagName('script')[0] || null)\n    resetServerIdleTimer()\n  } else {\n    cache = window[variable]\n\n    if (onClientConsumed) {\n      if (!cache || !cache.length) {\n        onClientConsumed()\n        onClientConsumed = null\n      } else {\n        resetClientIdleTimer()\n      }\n    }\n  }\n\n  function resetServerIdleTimer() {\n    clearTimeout(serverIdleTimer)\n\n    serverIdleTimer = setTimeout(() => {\n      script.text = `var ${variable} = ${JSON.stringify(cache)}`\n\n      if (onServerCached) {\n        onServerCached()\n        onServerCached = null\n      }\n    }, 450)\n  }\n\n  function resetClientIdleTimer() {\n    clearTimeout(clientIdleTimer)\n\n    if (onClientConsumed) {\n      clientIdleTimer = setTimeout(() => {\n        if (onClientConsumed) {\n          onClientConsumed()\n          onClientConsumed = null\n        }\n      }, 450)\n    }\n  }\n\n  return (ctx, next) => {\n    if (!ctx.options.method || ctx.options.method.toUpperCase() !== 'GET' || !cache) {\n      return next()\n    }\n\n    const key = cacheKeyGenerator ? cacheKeyGenerator(ctx) : ctx.url\n    const tag = tagGenerator ? tagGenerator(ctx) : ''\n    const hitIndex = cache.findIndex(item => item.key === key)\n    const hit = hitIndex === -1 ? null : cache[hitIndex]\n\n    if (mode === 'server') {\n      if (hit && hit.tag === tag) return hit.body\n\n      clearTimeout(serverIdleTimer)\n\n      return next().then(body => {\n        cache.push({ key, tag, body })\n        return body\n      }).finally(() => {\n        resetServerIdleTimer()\n      })\n    } else {\n      resetClientIdleTimer()\n\n      if (!hit) {\n        return next().finally(() => resetClientIdleTimer())\n      }\n\n      cache.splice(hitIndex, 1)\n      if (!cache.length) {\n        cache = null\n        if (onClientConsumed) {\n          clearTimeout(clientIdleTimer)\n          onClientConsumed()\n          onClientConsumed = null\n        }\n      }\n\n      if (hit.tag === tag) {\n        return hit.body\n      } else {\n        return next().finally(() => resetClientIdleTimer())\n      }\n    }\n  }\n}\n"],"names":["mode","variable","cacheKeyGenerator","tagGenerator","onServerCached","onClientConsumed","cache","script","serverIdleTimer","clientIdleTimer","document","createElement","body","insertBefore","getElementsByTagName","resetServerIdleTimer","window","length","resetClientIdleTimer","clearTimeout","setTimeout","text","JSON","stringify","ctx","next","options","method","toUpperCase","key","url","tag","hitIndex","findIndex","item","hit","then","push","finally","splice"],"mappings":"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"}