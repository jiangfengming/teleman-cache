{"version":3,"file":"telemanSSRCache.js","sources":["../src/index.mjs"],"sourcesContent":["export default ({\n  variable = '__SSR_CACHE__',\n  mode = window[variable] ? 'client' : 'server',\n  cacheKeyGenerator,\n  tagGenerator,\n  onServerRendered,\n  onClientPreloaded\n} = {}) => {\n  let cache, script, serverIdleTimer, clientIdleTimer\n\n  if (mode === 'server') {\n    if (onClientPreloaded) {\n      onClientPreloaded()\n    }\n\n    cache = []\n    resetServerIdleTimer()\n  } else {\n    if (window[variable]) {\n      cache = window[variable] = JSON.parse(decodeURI(window[variable]))\n    }\n\n    if (onClientPreloaded) {\n      if (!cache || !cache.length) {\n        onClientPreloaded()\n        onClientPreloaded = null\n      } else {\n        resetClientIdleTimer()\n      }\n    }\n  }\n\n  function resetServerIdleTimer() {\n    clearTimeout(serverIdleTimer)\n\n    serverIdleTimer = setTimeout(() => {\n      if (!script) {\n        script = document.createElement('script')\n        document.body.insertBefore(script, document.body.getElementsByTagName('script')[0] || null)\n      }\n\n      script.text = `var ${variable} = '${encodeURI(JSON.stringify(cache))}'`\n\n      if (onServerRendered) {\n        onServerRendered()\n        onServerRendered = null\n      }\n    }, 450)\n  }\n\n  function resetClientIdleTimer() {\n    clearTimeout(clientIdleTimer)\n\n    if (onClientPreloaded) {\n      clientIdleTimer = setTimeout(() => {\n        if (onClientPreloaded) {\n          onClientPreloaded()\n          onClientPreloaded = null\n        }\n      }, 450)\n    }\n  }\n\n  return (ctx, next) => {\n    if (!cache || ctx.options.method && ctx.options.method.toUpperCase() !== 'GET') {\n      return next()\n    }\n\n    const key = cacheKeyGenerator ? cacheKeyGenerator(ctx) : ctx.url\n    const tag = tagGenerator ? tagGenerator(ctx) : ''\n    const hitIndex = cache.findIndex(item => item.key === key)\n    const hit = hitIndex === -1 ? null : cache[hitIndex]\n\n    if (mode === 'server') {\n      if (hit && hit.tag === tag) {\n        return hit.body\n      }\n\n      clearTimeout(serverIdleTimer)\n\n      return next().then(body => {\n        cache.push({ key, tag, body })\n        return body\n      }).finally(() => {\n        resetServerIdleTimer()\n      })\n    } else {\n      resetClientIdleTimer()\n\n      if (!hit) {\n        return next().finally(() => resetClientIdleTimer())\n      }\n\n      cache.splice(hitIndex, 1)\n      if (!cache.length) {\n        cache = null\n\n        if (onClientPreloaded) {\n          clearTimeout(clientIdleTimer)\n          onClientPreloaded()\n          onClientPreloaded = null\n        }\n      }\n\n      if (hit.tag === tag) {\n        return hit.body\n      } else {\n        return next().finally(() => resetClientIdleTimer())\n      }\n    }\n  }\n}\n"],"names":["variable","mode","window","cacheKeyGenerator","tagGenerator","onServerRendered","onClientPreloaded","cache","script","serverIdleTimer","clientIdleTimer","resetServerIdleTimer","JSON","parse","decodeURI","length","resetClientIdleTimer","clearTimeout","setTimeout","document","createElement","body","insertBefore","getElementsByTagName","text","encodeURI","stringify","ctx","next","options","method","toUpperCase","key","url","tag","hitIndex","findIndex","item","hit","then","push","finally","splice"],"mappings":"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"}