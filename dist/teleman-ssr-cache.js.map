{"version":3,"file":"teleman-ssr-cache.js","sources":["../src/index.js"],"sourcesContent":["export default ({\n  variable = '__SSR_CACHE__',\n  mode = !window[variable] && /Headless/i.test(navigator.userAgent) ? 'server' : 'client',\n  cacheKeyGenerator,\n  onServerRendered,\n  onClientPreloaded\n} = {}) => {\n  let cache, script, serverIdleTimer, clientIdleTimer\n\n  if (mode === 'server') {\n    cache = []\n    resetServerIdleTimer()\n  } else {\n    if (window[variable]) {\n      cache = window[variable] = JSON.parse(decodeURI(window[variable]))\n    }\n\n    if (onClientPreloaded) {\n      if (!cache || !cache.length) {\n        onClientPreloaded()\n        onClientPreloaded = null\n      } else {\n        resetClientIdleTimer()\n      }\n    }\n  }\n\n  function resetServerIdleTimer() {\n    clearTimeout(serverIdleTimer)\n\n    serverIdleTimer = setTimeout(() => {\n      if (!script) {\n        script = document.createElement('script')\n        document.body.insertBefore(script, document.body.getElementsByTagName('script')[0] || null)\n      }\n\n      script.text = `var ${variable} = \"${encodeURI(JSON.stringify(cache))}\"`\n\n      if (onServerRendered) {\n        onServerRendered()\n        onServerRendered = null\n      }\n    }, 400)\n  }\n\n  function resetClientIdleTimer() {\n    clearTimeout(clientIdleTimer)\n\n    if (onClientPreloaded) {\n      clientIdleTimer = setTimeout(() => {\n        if (onClientPreloaded) {\n          onClientPreloaded()\n          onClientPreloaded = null\n        }\n      }, 400)\n    }\n  }\n\n  return (ctx, next) => {\n    if (!cache || ctx.options.method && ctx.options.method.toUpperCase() !== 'GET') {\n      return next()\n    }\n\n    const key = cacheKeyGenerator ? cacheKeyGenerator(ctx) : ctx.url\n    const hit = cache.find(item => item.key === key)\n\n    if (mode === 'server') {\n      if (hit) {\n        return hit.body\n      }\n\n      clearTimeout(serverIdleTimer)\n\n      return next().then(body => {\n        cache.push({\n          key,\n          body: JSON.parse(JSON.stringify(body)) // unreference\n        })\n        return body\n      }).finally(resetServerIdleTimer)\n    } else {\n      resetClientIdleTimer()\n\n      if (!hit) {\n        return next().finally(resetServerIdleTimer)\n      }\n\n      cleanCache()\n      return hit.body\n    }\n\n    function cleanCache() {\n      if (!cache) {\n        return\n      }\n\n      const i = cache.indexOf(hit)\n\n      if (i === -1) {\n        return\n      }\n\n      cache.splice(i, 1)\n\n      if (!cache.length) {\n        cache = null\n\n        if (onClientPreloaded) {\n          clearTimeout(clientIdleTimer)\n          onClientPreloaded()\n          onClientPreloaded = null\n        }\n      }\n    }\n  }\n}\n"],"names":["variable","mode","window","test","navigator","userAgent","cacheKeyGenerator","onServerRendered","onClientPreloaded","cache","script","serverIdleTimer","clientIdleTimer","resetServerIdleTimer","JSON","parse","decodeURI","length","resetClientIdleTimer","clearTimeout","setTimeout","document","createElement","body","insertBefore","getElementsByTagName","text","encodeURI","stringify","ctx","next","options","method","toUpperCase","key","url","hit","find","item","then","push","cleanCache","i","indexOf","splice"],"mappings":"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"}