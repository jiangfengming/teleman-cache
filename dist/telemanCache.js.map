{"version":3,"file":"telemanCache.js","sources":["../src/index.mjs"],"sourcesContent":["export default ({ mode, variable, cacheKeyFn, tagFn, onServerCached, onClientConsumed } = {}) => {\n  let cache, script\n\n  if (mode === 'server') {\n    if (onClientConsumed) onClientConsumed()\n    cache = []\n    script = document.createElement('script')\n    document.body.insertBefore(script, document.body.getElementsByTagName('script')[0] || null)\n    resetServerIdleTimer()\n  } else {\n    cache = window[variable]\n\n    if (onClientConsumed) {\n      if (!cache || !cache.length) {\n        onClientConsumed()\n        onClientConsumed = null\n      } else {\n        resetClientIdleTimer()\n      }\n    }\n  }\n\n  let serverIdleTimer\n  function resetServerIdleTimer() {\n    clearTimeout(serverIdleTimer)\n\n    serverIdleTimer = setTimeout(() => {\n      script.text = `var ${variable} = ${JSON.stringify(cache)}`\n\n      if (onServerCached) {\n        onServerCached()\n        onServerCached = null\n      }\n    }, 450)\n  }\n\n  let clientIdleTimer\n  function resetClientIdleTimer() {\n    clearTimeout(clientIdleTimer)\n\n    if (onClientConsumed) {\n      clientIdleTimer = setTimeout(() => {\n        if (onClientConsumed) {\n          onClientConsumed()\n          onClientConsumed = null\n        }\n      }, 450)\n    }\n  }\n\n  return (ctx, next) => {\n    if (!cache) return next()\n\n    const key = cacheKeyFn ? cacheKeyFn(ctx) : ctx.url\n    const tag = tagFn ? tagFn(ctx) : ''\n    const hitIndex = cache.findIndex(item => item.key === key)\n    const hit = hitIndex === -1 ? null : cache[hitIndex]\n\n    if (mode === 'server') {\n      if (hit && hit.tag === tag) return hit.body\n\n      clearTimeout(serverIdleTimer)\n\n      return next().then(body => {\n        cache.push({ key, tag, body })\n        return body\n      }).finally(() => {\n        resetServerIdleTimer()\n      })\n    } else {\n      resetClientIdleTimer()\n\n      if (!hit) {\n        return next().finally(() => resetClientIdleTimer())\n      }\n\n      cache.splice(hitIndex, 1)\n      if (!cache.length) {\n        cache = null\n        if (onClientConsumed) {\n          clearTimeout(clientIdleTimer)\n          onClientConsumed()\n          onClientConsumed = null\n        }\n      }\n\n      if (hit.tag === tag) {\n        return hit.body\n      } else {\n        return next().finally(() => resetClientIdleTimer())\n      }\n    }\n  }\n}\n"],"names":["mode","variable","cacheKeyFn","tagFn","onServerCached","onClientConsumed","cache","script","document","createElement","body","insertBefore","getElementsByTagName","resetServerIdleTimer","window","length","resetClientIdleTimer","serverIdleTimer","clearTimeout","setTimeout","text","JSON","stringify","clientIdleTimer","ctx","next","key","url","tag","hitIndex","findIndex","item","hit","then","push","finally","splice"],"mappings":"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"}